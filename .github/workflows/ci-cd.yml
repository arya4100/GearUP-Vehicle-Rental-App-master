name: CI/CD Pipeline

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Triggers
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    branches:
      - main          # Runs on every merge to main
  pull_request:
    branches:
      - main          # Runs on every PR targeting main

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Job 1 â€“ Build & Security Scan
# Runs for BOTH push to main AND pull requests
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  build-and-security:
    name: Build & Security Scan
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: final-demo   # React app lives here

    steps:
      # 1. Checkout full history (needed for secret scanning)
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Set up Node 18
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: final-demo/package-lock.json

      # 3. Install dependencies
      - name: Install Dependencies
        run: npm ci

      # 4. Build the React app
      - name: Build Project
        run: npm run build

      # 5. ğŸ” Secret / credential scan using TruffleHog
      #    Scans the entire git history for leaked API keys, passwords, tokens, etc.
      #    No license key required â€“ works on public AND private repos.
      - name: Secret Scan (TruffleHog)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified   # Only flag secrets that are provably real (reduces noise)

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2 â€“ Deploy to Firebase Hosting
  # Runs ONLY when code is merged (pushed) to main
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Deploy to Firebase Hosting
    needs: build-and-security        # Must pass build + security before deploy
    runs-on: ubuntu-latest

    # Deploy only on direct push to main (not on pull request events)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    defaults:
      run:
        working-directory: final-demo

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: final-demo/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Build Project
        run: npm run build

      # Deploy built output (final-demo/build) to Firebase Hosting
      # FIREBASE_TOKEN must be added as a GitHub secret in:
      # Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret
      - name: Deploy to Firebase Hosting
        run: |
          npm install -g firebase-tools
          firebase deploy --only hosting --token "${{ secrets.FIREBASE_TOKEN }}"
        working-directory: ${{ github.workspace }}   # firebase.json is at repo root
